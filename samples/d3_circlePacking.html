<!DOCTYPE html>
<!--
Copyright 2018 SAS Institute Inc.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
https://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <!-- Import D3.js -->
  <script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>

  <!-- Import utilities  -->
  <script type="text/javascript" src="../util/messagingUtil.js"></script>
  <script type="text/javascript" src="../util/contentUtil.js"></script>
</head>
<body>
  <style type="text/css">
  html, body, svg {
/*  overflow: hidden;*/
    margin: 0px;
    width: 100%;
    height: 100%;
  }
  .grid{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(98px, 1fr));
    grid-auto-rows: auto;
  };

  .book {
    border-radius:0px;
    background-color:#808080;
  }

</style>

<script>
"use strict";

document.addEventListener("DOMContentLoaded", function() {
  /******************************************************* Declare variables *******************************************************/

  // Static data variables
  const SAMPLE_MESSAGE = {
    version: "1",
    resultName: "dd75",
    rowCount: 6,
    availableRowCount: 6,
    data: [
      [
      'https://images.gr-assets.com/books/1447303603m/2767052.jpg',
       1,
      "The Hunger Games (The Hunger Games, #1)"],
      [
       'https://images.gr-assets.com/books/1474154022m/3.jpg',
       2,
       "Harry Potter and the Sorcerer's Stone (Harry Potter, #1)"],
      [
       'https://images.gr-assets.com/books/1361039443m/41865.jpg',
       3,
       "Twilight (Twilight, #1)"],
      [
       'https://images.gr-assets.com/books/1361975680m/2657.jpg',
       4,
       "To Kill a Mockingbird"],
      [
       'https://images.gr-assets.com/books/1490528560m/4671.jpg',
       5,
       "The Great Gatsby"]
    ],
    columns: [
      {
        name: "image_url",
        label: "image_url",
        type: "string"
      },
      {
        name: "id",
        label: "id",
        type: "string"
      },
      {
        name:'title',
        label: 'title',
        type: 'string'
      }
    ]
  }; // Sample data message to render graph outside of VA for debugging

  // Dynamic data variables
  let VA_MESSAGE; // Data message to be received from VA
  let VA_RESULT_NAME; // Result name required to send messages back to VA
  let VA_DATA; // Data to be parsed from VA message
  let DATA; // Data used to create graph

  // Selection and d3 variables
  let GRID; // Grid for book images
  let BOOK; // Book data-join
  let IMAGE; // Book image

  /*************************************************** Setup Callback Functions ***************************************************/

  // Attach event for data message from VA
  va.messagingUtil.setOnDataReceivedCallback(onDataReceived);

  // If not being rendered in iFrame (outside VA), render with sample data
  if (!inIframe()) {
    onDataReceived(SAMPLE_MESSAGE);
  }

  /****************************************************** Callback Functions ******************************************************/

  // Take action on received data
  function onDataReceived(messageFromVA) {
    // Initialize data variables
    VA_MESSAGE = messageFromVA;
    VA_RESULT_NAME = messageFromVA.resultName;

    if (!VA_RESULT_NAME) VA_MESSAGE=SAMPLE_MESSAGE;

    // Validate data roles
    if (
      !va.contentUtil.validateRoles(
        messageFromVA,
        ["string", "string",'string'],
        ["number"]
      )
    ) {
      va.messagingUtil.postInstructionalMessage(
        VA_RESULT_NAME,
        "D3 Book Images expects columns to be assigned in this order:\n" +
          " 1. Image URL (string)\n" +
          " 2. ID (string)\n" +
          " 3. Title (string)"
      );
      return;
    }

    // Restructure data from 2d array to array of objects
    DATA = [];
    for (let i = 0; i < VA_MESSAGE.data.length; i++) {
      DATA.push({
        image_url: VA_MESSAGE.data[i][0],
        id: VA_MESSAGE.data[i][1],
        title: VA_MESSAGE.data[i][2],
        selected: VA_MESSAGE.data[i][3],
        index: i
      });
    }

    // Initialize chart if first draw, otherwise process data and update elements accordingly
    if (d3.select('div').empty()) {
      drawElements();
    } else {
      updateElements();
    }
  }

  // Draw elements for first time and on resize event
  function drawElements() {
    // Return if data is not yet initialized
    if (!DATA) {
      return;
    }

    //Creates a grid
    var GRID=d3.select('body')
               .append('div')
                  .attr('id','grid')
                  .attr('class','grid');

    //Adds g for each book
    BOOK=GRID.selectAll('g')
                 .data(DATA, function(d) {
                   return d.id
                 })
                 .enter()
                 .append('g')
                    .attr('id','book');

    //Add image to each block
    var IMAGE=BOOK.append('svg')
                    .attr('id','book-image')
                .append('svg:image')
                .attr('xlink:href', function(d) {
                    return d.image_url;
                  })
                  .append('title')
                  .text(function(d) {
                    return d.title;
                  });

  }

  // Redraw data dependent elements on data change
  function updateElements() {

    // Enter/Update/Exit data bars
    BOOK=d3.select('#grid').selectAll('g')
        .data(DATA, function(d) {
          return d.id;
        });

    BOOK.enter()
        .append('g')
        .append('svg')
      .append("svg:image")
      .attr('xlink:href', function(d) {
        return d.image_url;
      })
      .append('title')
      .text(function(d) {
        return d.title;
      });

    BOOK.exit()
      .remove();
  }

  /******************************************************* Helper Functions *******************************************************/

  // Determine whether or not page is being rendered in iFrame
  function inIframe() {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  }

});
</script>
</body>
</html>
